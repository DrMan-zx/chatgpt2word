# å¼€å‘æŒ‡å—

æœ¬æ–‡æ¡£ä¸ºå¼€å‘è€…æä¾›é¡¹ç›®çš„å¼€å‘ã€è°ƒè¯•å’Œæ‰©å±•æŒ‡å—ã€‚

## ğŸ—ï¸ é¡¹ç›®æ¶æ„

### æ•´ä½“æ¶æ„

```
Browser Extension (JavaScript) â†â†’ HTTP API â†â†’ FastAPI (Python) â†â†’ Pandoc
                                    â†“
                              BeautifulSoup4 (HTML parsing)
                                    â†“
                              KaTeX LaTeX extraction
```

### æ•°æ®æµ

1. **æ‰©å±•æå–** - content.js æå– ChatGPT DOM â†’ HTML å­—ç¬¦ä¸²
2. **API è°ƒç”¨** - background.js å‘é€ POST /convert â†’ multipart/form-data
3. **HTML è§£æ** - FastAPI ä½¿ç”¨ BeautifulSoup â†’ è§£æ KaTeX å…¬å¼
4. **LaTeX æå–** - æå– `<annotation encoding="application/x-tex">` å†…å®¹
5. **Markdown ç”Ÿæˆ** - æ›¿æ¢ä¸º `$$...$$` æ ¼å¼
6. **Pandoc è½¬æ¢** - markdown â†’ .docx
7. **æ–‡ä»¶è¿”å›** - StreamingResponse â†’ æµè§ˆå™¨ä¸‹è½½

## ğŸ› ï¸ å¼€å‘ç¯å¢ƒæ­å»º

### 1. API å¼€å‘ç¯å¢ƒ

**å®‰è£…ä¾èµ–:**
```bash
cd api
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate
pip install -r requirements.txt
```

**å¯åŠ¨å¼€å‘æœåŠ¡å™¨:**
```bash
uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

**è®¿é—® API æ–‡æ¡£:**
- Swagger UI: http://localhost:8000/docs
- ReDoc: http://localhost:8000/redoc

### 2. æ‰©å±•å¼€å‘ç¯å¢ƒ

**æ— éœ€å®‰è£… - åŠ è½½å·²è§£å‹çš„æ‰©å±•:**
1. æ‰“å¼€ `chrome://extensions/`
2. å¼€å¯"å¼€å‘è€…æ¨¡å¼"
3. ç‚¹å‡»"åŠ è½½å·²è§£å‹çš„æ‰©å±•ç¨‹åº"
4. é€‰æ‹© `extension/chrome`
5. ä¿®æ”¹æ‰©å±•æ–‡ä»¶ååˆ·æ–°æ‰©å±•é¡µé¢

**Chrome DevTools:**
- æ‰©å±•åå°è„šæœ¬: `chrome://extensions/` â†’ "æ£€æŸ¥è§†å›¾"
- æ‰©å±•å¼¹çª—: å³é”®æ‰©å±•å›¾æ ‡ â†’ "æ£€æŸ¥å¼¹å‡ºå†…å®¹"
- å†…å®¹è„šæœ¬: æŒ‰ F12 æ‰“å¼€ DevToolsï¼ŒæŸ¥çœ‹ Console

## ğŸ“ ä»£ç ç»“æ„è¯¦è§£

### API ä»£ç  (api/)

```
api/
â”œâ”€â”€ main.py                 # FastAPI åº”ç”¨å…¥å£
â”‚   â”œâ”€â”€ app = FastAPI(...)  # åº”ç”¨å®ä¾‹
â”‚   â”œâ”€â”€ /convert            # è½¬æ¢ç«¯ç‚¹
â”‚   â”œâ”€â”€ /health             # å¥åº·æ£€æŸ¥
â”‚   â”œâ”€â”€ validate_html()     # HTML éªŒè¯
â”‚   â”œâ”€â”€ sanitize_filename() # æ–‡ä»¶åæ¸…ç†
â”‚   â””â”€â”€ convert_html_to_docx()  # æ ¸å¿ƒè½¬æ¢é€»è¾‘
â”‚
â”œâ”€â”€ html2word.py            # åŸå§‹è½¬æ¢è„šæœ¬
â”‚   â””â”€â”€ (æ—§ç‰ˆæœ¬ï¼Œä¿æŒå…¼å®¹)
â”‚
â”œâ”€â”€ requirements.txt        # Python ä¾èµ–
â”œâ”€â”€ Dockerfile             # å®¹å™¨æ„å»º
â””â”€â”€ docker-compose.yml     # æœåŠ¡ç¼–æ’
```

### æ‰©å±•ä»£ç  (extension/chrome/)

```
extension/chrome/
â”œâ”€â”€ manifest.json           # æ‰©å±•æ¸…å• (Manifest V3)
â”œâ”€â”€ background.js           # Service Worker (åå°è„šæœ¬)
â”œâ”€â”€ content.js              # Content Script (å†…å®¹è„šæœ¬)
â”œâ”€â”€ options.html            # é€‰é¡¹é¡µé¢
â”œâ”€â”€ options.js              # é€‰é¡¹è„šæœ¬
â”œâ”€â”€ popup/                  # å¼¹çª— UI
â”‚   â”œâ”€â”€ popup.html         # å¼¹çª—ç»“æ„
â”‚   â”œâ”€â”€ popup.css          # å¼¹çª—æ ·å¼
â”‚   â””â”€â”€ popup.js           # å¼¹çª—é€»è¾‘
â””â”€â”€ icons/                  # æ‰©å±•å›¾æ ‡
    â”œâ”€â”€ README.md          # å›¾æ ‡è¯´æ˜
    â””â”€â”€ (icon16.png, icon32.png, etc.)
```

## ğŸ”§ æ ¸å¿ƒåŠŸèƒ½å®ç°

### 1. HTML è½¬æ¢ (api/main.py)

```python
def convert_html_to_docx(html_content: str) -> bytes:
    """
    è½¬æ¢æµç¨‹:
    1. BeautifulSoup è§£æ HTML
    2. æå– LaTeX å…¬å¼
    3. ç”Ÿæˆ Markdown
    4. Pandoc è½¬æ¢
    """
    # è§£æ HTML
    soup = BeautifulSoup(html_content, "lxml")

    # æå– KaTeX LaTeX
    for ann in soup.find_all("annotation", {"encoding": "application/x-tex"}):
        latex_code = ann.get_text().strip()
        katex_span = ann.find_parent("span", class_="katex")
        if katex_span:
            katex_span.replace_with(f"\n$$ {latex_code} $$\n")

    # è·å–çº¯æ–‡æœ¬ï¼ˆå¸¦å…¬å¼ï¼‰
    text = soup.get_text()
    text = re.sub(r'\n\s*\n\s*\n+', '\n\n', text).strip()

    # ä½¿ç”¨ Pandoc è½¬æ¢
    with tempfile.TemporaryDirectory() as tmpdir:
        md_file = Path(tmpdir) / "temp.md"
        docx_file = Path(tmpdir) / "temp.docx"

        with open(md_file, "w", encoding="utf-8") as f:
            f.write(text)

        subprocess.run(
            ["pandoc", str(md_file), "-o", str(docx_file)],
            timeout=PANDOC_TIMEOUT,
            check=True
        )

        return open(docx_file, "rb").read()
```

### 2. æ‰©å±•å†…å®¹è„šæœ¬ (extension/chrome/content.js)

```javascript
/**
 * æå–å¯¹è¯å†…å®¹
 */
function extractConversations() {
  const main = document.querySelector('main');

  if (!main) {
    throw new Error('Conversation container not found');
  }

  // å…‹éš†å¹¶æ¸…ç†
  const clone = main.cloneNode(true);
  removeUnnecessaryElements(clone);

  return clone.outerHTML;
}

/**
 * æ¸…ç†ä¸éœ€è¦çš„å…ƒç´ 
 */
function removeUnnecessaryElements(container) {
  // ç§»é™¤è„šæœ¬
  container.querySelectorAll('script').forEach(el => el.remove());

  // ç§»é™¤ç³»ç»Ÿæ¶ˆæ¯
  container.querySelectorAll('[data-message-author-role="system"]')
    .forEach(el => el.remove());
}
```

### 3. æ‰©å±•åå°è„šæœ¬ (extension/chrome/background.js)

```javascript
/**
 * è½¬æ¢ HTML ä¸º Word
 */
async function convertToWord(html, filename) {
  const { apiUrl } = await chrome.storage.local.get({ apiUrl: DEFAULT_API_URL });

  const formData = new FormData();
  formData.append('html', html);
  if (filename) formData.append('filename', filename);

  const response = await fetch(`${apiUrl}/convert`, {
    method: 'POST',
    body: formData
  });

  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.message);
  }

  // ä¸‹è½½æ–‡ä»¶
  const blob = await response.blob();
  const url = URL.createObjectURL(blob);
  await chrome.downloads.download({ url, filename: `${filename}.docx` });
}
```

## ğŸ› è°ƒè¯•æŒ‡å—

### 1. è°ƒè¯• API

**æŸ¥çœ‹æ—¥å¿—:**
```bash
# Docker
docker-compose logs -f api

# æœ¬åœ°
uvicorn main:app --reload  # æ—¥å¿—è¾“å‡ºåˆ°æ§åˆ¶å°
```

**ä½¿ç”¨ curl æµ‹è¯•:**
```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:8000/health

# è½¬æ¢æµ‹è¯•
curl -X POST http://localhost:8000/convert \
  -F "html=@test.html" \
  -F "filename=test" \
  --output result.docx
```

**æŸ¥çœ‹ API æ–‡æ¡£:**
è®¿é—® http://localhost:8000/docs è¿›è¡Œäº¤äº’å¼æµ‹è¯•

### 2. è°ƒè¯•æ‰©å±•

**åå°è„šæœ¬:**
1. æ‰“å¼€ `chrome://extensions/`
2. æ‰¾åˆ°æ‰©å±•ï¼Œç‚¹å‡»"æ£€æŸ¥è§†å›¾"
3. Console æ ‡ç­¾é¡µæŸ¥çœ‹æ—¥å¿—

**å¼¹çª—:**
1. å³é”®æ‰©å±•å›¾æ ‡
2. ç‚¹å‡»"æ£€æŸ¥å¼¹å‡ºå†…å®¹"
3. æŸ¥çœ‹ Console å’Œ Network æ ‡ç­¾

**å†…å®¹è„šæœ¬:**
1. æ‰“å¼€ ChatGPT é¡µé¢
2. æŒ‰ F12 æ‰“å¼€ DevTools
3. åœ¨ Console æ ‡ç­¾æŸ¥çœ‹ content.js æ—¥å¿—

**æ³¨å…¥è°ƒè¯•ä»£ç :**
```javascript
// åœ¨ content.js ä¸­
console.log('Debug: Current URL', window.location.href);
console.log('Debug: Main element', document.querySelector('main'));
```

### 3. å¸¸è§é—®é¢˜æ’æŸ¥

**æ‰©å±•æ— æ³•æ³¨å…¥:**
- æ£€æŸ¥ manifest.json ä¸­çš„ `matches` é…ç½®
- ç¡®è®¤åœ¨æ­£ç¡®çš„åŸŸåä¸Š
- æŸ¥çœ‹æ‰©å±•çš„ "Errors" æ ‡ç­¾

**API è¯·æ±‚å¤±è´¥:**
- æ£€æŸ¥ç½‘ç»œè¯·æ±‚ (DevTools â†’ Network)
- æŸ¥çœ‹æ‰©å±•åå°è„šæœ¬æ—¥å¿—
- éªŒè¯ API æœåŠ¡å™¨çŠ¶æ€

**è½¬æ¢å¤±è´¥:**
- æ£€æŸ¥ API æ—¥å¿—
- éªŒè¯ HTML åŒ…å« KaTeX å…¬å¼
- å°è¯•æ‰‹åŠ¨è°ƒç”¨ API è°ƒè¯•

## ğŸ§ª æµ‹è¯•

### 1. API å•å…ƒæµ‹è¯•

**åˆ›å»ºæµ‹è¯•æ–‡ä»¶ (tests/api/test_conversion.py):**
```python
import pytest
from fastapi.testclient import TestClient
from api.main import app

client = TestClient(app)

def test_health():
    response = client.get("/health")
    assert response.status_code == 200
    assert response.json() == {"status": "healthy"}

def test_convert_with_katex():
    html = '''
    <!DOCTYPE html>
    <html>
    <body>
      <span class="katex">
        <annotation encoding="application/x-tex">x^2</annotation>
      </span>
    </body>
    </html>
    '''
    response = client.post("/convert", data={"html": html})
    assert response.status_code == 200
    assert response.headers["content-type"] == \
        "application/vnd.openxmlformats-officedocument.wordprocessingml.document"

def test_convert_without_katex():
    response = client.post("/convert", data={"html": "<html><body>No formulas</body></html>"})
    assert response.status_code == 422
    assert response.json()["error"] == "no_formulas"
```

**è¿è¡Œæµ‹è¯•:**
```bash
cd api
pytest tests/api/ -v
```

### 2. æ‰©å±•åŠŸèƒ½æµ‹è¯•

**æ‰‹åŠ¨æµ‹è¯•æ¸…å•:**
- [ ] æ‰©å±•æ­£ç¡®æ³¨å…¥ ChatGPT é¡µé¢
- [ ] å¼¹çª—æ˜¾ç¤ºæ­£ç¡®çŠ¶æ€
- [ ] å¯ä»¥æå– HTML
- [ ] å¯ä»¥è°ƒç”¨ API
- [ ] å¯ä»¥ä¸‹è½½æ–‡ä»¶
- [ ] é”™è¯¯å¤„ç†æ­£ç¡®

**è‡ªåŠ¨åŒ–æµ‹è¯• (Puppeteer):**
```javascript
// tests/extension/test-extraction.js
const puppeteer = require('puppeteer');

test('Extract HTML from ChatGPT', async () => {
  const browser = await puppeteer.launch();
  const page = await browser.newPage();
  await page.goto('https://chat.openai.com');

  // æ³¨å…¥å†…å®¹è„šæœ¬
  await page.addScriptTag({ path: 'extension/chrome/content.js' });

  // æå– HTML
  const html = await page.evaluate(() => {
    return extractConversations();
  });

  expect(html).toContain('katex');
  await browser.close();
});
```

## ğŸ”„ è´¡çŒ®ä»£ç 

### å¼€å‘æµç¨‹

1. **Fork ä»“åº“**
2. **åˆ›å»ºåˆ†æ”¯**
   ```bash
   git checkout -b feature/your-feature
   ```

3. **å¼€å‘åŠŸèƒ½**
   - éµå¾ªé¡¹ç›®ä»£ç é£æ ¼
   - æ·»åŠ å¿…è¦æ³¨é‡Š
   - ç¼–å†™æµ‹è¯•ç”¨ä¾‹

4. **æµ‹è¯•**
   ```bash
   # API æµ‹è¯•
   cd api && pytest

   # æ‰©å±•æµ‹è¯•
   npm test
   ```

5. **æäº¤**
   ```bash
   git add .
   git commit -m "feat: add new feature"
   git push origin feature/your-feature
   ```

6. **åˆ›å»º Pull Request**

### ä»£ç è§„èŒƒ

**Python (API):**
- éµå¾ª PEP 8
- ä½¿ç”¨ Black æ ¼å¼åŒ–: `black api/`
- ä½¿ç”¨ isort æ’åºå¯¼å…¥: `isort api/`
- ç±»å‹æç¤º: æ‰€æœ‰å‡½æ•°å¿…é¡»æœ‰ç±»å‹æ³¨è§£
- æ–‡æ¡£å­—ç¬¦ä¸²: ä½¿ç”¨ Google é£æ ¼

**JavaScript (æ‰©å±•):**
- ä½¿ç”¨ ESLint æ£€æŸ¥
- ç®­å¤´å‡½æ•°ä¼˜å…ˆ
- ä½¿ç”¨ const/letï¼Œé¿å… var
- æ³¨é‡Šå…³é”®é€»è¾‘
- é”™è¯¯å¤„ç†: try-catch + ç”¨æˆ·æç¤º

### æäº¤æ¶ˆæ¯è§„èŒƒ

**æ ¼å¼:**
```
<type>(<scope>): <subject>

<body>

<footer>
```

**Type:**
- feat: æ–°åŠŸèƒ½
- fix: ä¿®å¤ bug
- docs: æ–‡æ¡£æ›´æ–°
- style: ä»£ç æ ¼å¼
- refactor: é‡æ„
- test: æµ‹è¯•
- chore: æ„å»º/å·¥å…·

**ç¤ºä¾‹:**
```
feat(api): add support for PDF output

- Add output_format parameter to /convert endpoint
- Update Pandoc command to support PDF generation
- Add tests for PDF conversion

Closes #123
```

## ğŸ“š æ‰©å±•å¼€å‘

### æ·»åŠ æ–°åŠŸèƒ½

**API ç«¯ç‚¹:**
1. åœ¨ `api/main.py` æ·»åŠ æ–°çš„è·¯ç”±
2. æ›´æ–° `api/requirements.txt` å¦‚æœéœ€è¦æ–°ä¾èµ–
3. æ·»åŠ æµ‹è¯•ç”¨ä¾‹
4. æ›´æ–°æ–‡æ¡£

**æ‰©å±•åŠŸèƒ½:**
1. åœ¨ `extension/chrome/` æ·»åŠ ç›¸åº”æ–‡ä»¶
2. æ›´æ–° `manifest.json` å¦‚æœéœ€è¦æ–°æƒé™
3. æµ‹è¯•æ–°åŠŸèƒ½
4. æ›´æ–° README

### è‡ªå®šä¹‰ Pandoc è¾“å‡º

**ä¿®æ”¹è½¬æ¢æ ¼å¼:**
```python
# api/main.py
cmd = [
    "pandoc",
    str(md_file),
    "-o", str(docx_file),
    "--from", "markdown",
    "--to", "docx",
    "--reference-doc", "/path/to/template.docx"  # ä½¿ç”¨è‡ªå®šä¹‰æ¨¡æ¿
]
```

**æ”¯æŒçš„è¾“å‡ºæ ¼å¼:**
- docx: Microsoft Word
- pdf: PDF (éœ€è¦ LaTeX)
- odt: OpenDocument Text
- html: HTML (ç®€å•è½¬æ¢)

### æ·»åŠ æ–°éªŒè¯è§„åˆ™

**API ç«¯éªŒè¯:**
```python
def validate_custom(html: str) -> bool:
    if "custom-tag" not in html:
        raise HTTPException(
            status_code=422,
            detail={"error": "missing_custom", "message": "Custom tag required"}
        )
    return True
```

### ç¼“å­˜å®ç°

**åŸºäºå†…å®¹ hash:**
```python
import hashlib
from functools import lru_cache

@lru_cache(maxsize=100)
def convert_with_cache(html: str) -> bytes:
    return convert_html_to_docx(html)

def get_cache_key(html: str) -> str:
    return hashlib.md5(html.encode()).hexdigest()
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### API æ€§èƒ½

**ç›‘æ§æŒ‡æ ‡:**
- è¯·æ±‚å“åº”æ—¶é—´
- å¹¶å‘è¯·æ±‚æ•°
- è½¬æ¢æˆåŠŸç‡
- èµ„æºä½¿ç”¨ç‡

**ä¼˜åŒ–ç­–ç•¥:**
- æ·»åŠ è¿›ç¨‹æ±  (å·²è®¡åˆ’)
- å®ç°ç¼“å­˜
- å¼‚æ­¥å¤„ç†
- é™æµä¿æŠ¤

### æ‰©å±•æ€§èƒ½

**ä¼˜åŒ–æŠ€å·§:**
- é¿å…é¢‘ç¹ DOM æŸ¥è¯¢
- ä½¿ç”¨é˜²æŠ–å¤„ç†ç”¨æˆ·è¾“å…¥
- ç¼“å­˜æå–çš„ HTML
- æœ€å°åŒ–æ¶ˆæ¯ä¼ é€’

## ğŸ” å®‰å…¨è€ƒè™‘

**API å®‰å…¨:**
- éªŒè¯ HTML å¤§å° (å·²å®ç°: 50MB é™åˆ¶)
- æ¸…ç†æ–‡ä»¶å (å·²å®ç°)
- è¶…æ—¶ä¿æŠ¤ (å·²å®ç°: 30s)
- æœªæ¥: æ·»åŠ è®¤è¯

**æ‰©å±•å®‰å…¨:**
- ä»…è¯·æ±‚å¿…è¦æƒé™
- ä¸åœ¨é¡µé¢ä¸­æ‰§è¡Œ eval
- å®‰å…¨å¤„ç†ç”¨æˆ·è¾“å…¥
- éªŒè¯ API å“åº”

**ç½‘ç»œå®‰å…¨:**
- ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ HTTPS
- éªŒè¯ SSL è¯ä¹¦
- é˜²æ­¢ XSS æ”»å‡»
- API é™æµ

## ğŸ“– ç›¸å…³èµ„æº

- [FastAPI æ–‡æ¡£](https://fastapi.tiangolo.com/)
- [Chrome Extension æ–‡æ¡£](https://developer.chrome.com/docs/extensions/)
- [Pandoc æ‰‹å†Œ](https://pandoc.org/MANUAL.html)
- [BeautifulSoup æ–‡æ¡£](https://www.crummy.com/software/BeautifulSoup/bs4/doc/)
- [KaTeX è¯­æ³•](https://katex.org/docs/supported.html)

## â“ è·å–å¸®åŠ©

- æŸ¥çœ‹ [README.md](../README.md) äº†è§£ä½¿ç”¨
- æŸ¥çœ‹ [API è®¾è®¡æ–¹æ¡ˆ](APIè®¾è®¡æ–¹æ¡ˆ.md) äº†è§£æ¶æ„
- æŸ¥çœ‹ [å®‰è£…æŒ‡å—](å®‰è£…æŒ‡å—.md) äº†è§£éƒ¨ç½²
- æäº¤ [GitHub Issue](repository-url/issues) æŠ¥å‘Šé—®é¢˜
- åŠ å…¥ [Discord ç¤¾åŒº](community-link) è®¨è®º
